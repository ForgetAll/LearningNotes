### CAP 三指标

* 一致性（Consistency）
* 可用性（Availability）
* 分区容错性（Partition Tolerance）

一致性：一致性强调的不是数据完整，而是各节点间的数据一致

可用性：任何来自客户端的请求，不管访问哪个节点，都能得到响应数据，但不保证是同一份最新的数据。

分区容错性：集群对分区故障的容错能力

CAP 只能在 3 个指标中选择 2 个。

分布式系统中，分区故障时必然发生的，P 是前提，抛弃了 P 等于放弃了分布式系统

* CP，因为消息丢失、延迟过高发生了网络分区，部分节点无法保证特定信息是最新的，那么这个时候，集群节点接收到来自客户端的写请求时，因为无法保证所有节点都是最新信息，所以系统将返回写失败错误，也就是说集群拒绝新数据写入
* AP，系统将处理客户端的查询，返回特定信息，如果发生了网络分区，一些节点将无法返回最新的特定信息，他们将返回自己当前的相对新的信息

一致性不等同于完整性



### 二阶段提交协议

由协调者（Coordinator）发起二阶段提交

* 提交请求阶段（投票阶段）
  * 在一个参与者投票要求提交事务之前，它必须保证能够执行提交协议中它自己的那一部分，即使参与者出现故障或中途被替换掉
* 提交执行阶段（完成阶段）
  * 事务的每个参与者执行最终统一的决定，提交事务或放弃事务。这个约定是为了实现 ACID 中的原子性



### TCC（Try-Confirm-Cancel）

Try（预留）、Confirm（确认）、Cancel（撤销），包含预留、确认或撤销这 2 个阶段。

预留阶段，各个节点执行预留操作。所有节点都预留成功则进入确认阶段，如果预留出错则进入撤销阶段

TCC 本质上是补偿事务，核心思想是针对每个操作都要注册一个与其对应的确认操作和补偿操作（也就是撤销操作）。TCC 的 3 个操作是需要在业务代码中编码实现的，为了实现一致性，确认操作和补偿操作必须是幂等的，因为这 2 个操作可能会失败重试。



* 二阶段提交协议，不仅仅是协议，也是一种非常经典的思想。二阶段提交在达成提交操作共识的算法中应用广泛，比如 XA 协议、TCC、Paxos、Raft 等。
* 幂等性，是指同一操作对同一系统的任意多次执行，所产生的的影响均与一次执行的影响相同，不会因为多次执行而产生副作用。常见的实现方法有 Token、索引等。它的本职是通过唯一标识，标记同一操作的方式，来消除多次执行的副作用。
* Paxos、Raft 等强一致性算法，也采用了二阶段提交，在“提交请求阶段”，只要大多数节点确认就可以，而具有 ACID 特性的事务，则要求全部节点确认可以。可以将具有 ACID 特性的操作，理解为最强的一致性。

在开发实现分布式系统，如果不是必须，尽量不要实现事务，可以考虑采用强一致性或最终一致性。

